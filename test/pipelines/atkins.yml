matrix:
  goarch: ["amd64", "arm64"]

name: Pipeline ${goarch}

jobs:
  build:
    desc: "Build application"
    runs_on: ubuntu-latest
    steps:
      - name: "Checkout code"
        run: echo "Checking out code"
      - name: "Run tests"
        run: go test ./...
      - name: "Build binary"
        run: go build -o ./bin/atkins ./cmd/atkins
      - name: "Sleep 5"
        run: sleep 5
      - name: "Sleep 3"
        run: sleep 3

  lint:
    desc: "Run linters"
    runs_on: ubuntu-latest
    steps:
      - name: "Run go fmt"
        run: go fmt ./...
      - name: "Run go vet"
        run: go vet ./...

  matrix_build:
    desc: "Build"
    runs_on: ubuntu-latest
    steps:
      - name: "Print architecture"
        run: |
          echo "Architecture: ${goarch}"
      - name: "Build"
        run: |
          echo "Building binary for ${goarch}"

  docker_test:
    desc: "Test with Docker service"
    runs_on: ubuntu-latest
    container: golang:1.21
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - name: "Verify Redis connection"
        run: echo "Connecting to Redis on localhost:6379"
